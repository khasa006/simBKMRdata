---
title: "Helper Functions for Bayesian Kernel Machine Regression"
subtitle: "Simulating Multivariate Environmental Exposure Data and Estimating Feature Selection Thresholds"
date: "2025-04-07"
author: "Kazi Tanvir Hasan and Gabriel J. Odom"
output:
  rmarkdown::html_document:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{simBKMR R Package}
  %\VignetteEngine{quarto::html}
  %\VignetteLanguage{en}
bibliography: references.bib
---

# Abstract

In environmental health studies, the relationship between multiple environmental exposures and health outcomes, such as cognitive development, is often investigated using complex datasets that exhibit non-normality. This paper introduces an R package designed to simulate multivariate environmental exposure data and estimate feature selection thresholds to aid in research to apply and extend the Bayesian Kernel Machine Regression (BKMR) methodology. The package enables researchers to generate data from multivariate normal and multivariate skewed Gamma distributions, common in environmental exposure research, and calculate multivariate statistical features such as mean, variance, skewness, shape, and scale vectors, and correlation matrices. This package also facilitates the calculation of a Posterior Inclusion Probability (PIP) threshold for feature selection in BKMR, offering an approach that accounts for non-normal data (based on the work in [CITE]). The effectiveness of the package is demonstrated through a real-world application using data from an adolescent environmental exposure study, where metal exposures are related to IQ scores.

## Keywords

R package, Bayesian Kernel Machine Regression, multivariate simulation, feature selection, environmental exposure, statistical moments, multivariate Gamma distribution, skewed data

# Introduction

Environmental exposure to metals such as Cadmium, Mercury, Arsenic, and Lead is linked to various adverse health outcomes, especially among children [@Horton2013]. In particular, these exposures may influence cognitive functions, with effects that often vary based on the concentration of metals in the environment [@Sanders2015; @trasande2011; @tyler2014; @tolins2014]. Research into these relationships frequently involves complex, multivariate datasets where environmental factors are correlated, and data distributions often exhibit skewness rather than normality [@bobb2014; @bobb2018; @hasan2024].

The Bayesian Kernel Machine Regression (BKMR) model is a powerful method for identifying relevant environmental factors and interactions [@bobb2014; @bobb2018; @wilson2022; @devick2022; @gerwinn2010; @ibrahimou2024]. However, its effectiveness is typically constrained by its assumption of normality in the data, which is frequently violated in environmental health studies [@bobb2014; @bobb2018; @hasan2024; @Van2021]. To allow BKMR to flexibly handle multivariate skewed data, ongoing methodological innovation is needed, and synthetic data sets are a critical component of this research. To fill this need for realistic synthetic data sets, we have developed an R package that facilitates parametric bootstrap data simulation for multivariate environmental exposures. Further, this package includes computational results to estimate a Posterior Inclusion Probability (PIP) threshold which enables feature selection for BKMR via a hypothesis testing framework with controlled test size, which is particularly useful when data deviate from multivariate normality [@hasan2024]. In this chapter, we show how to estimate key statistical moments from a real data set which includes effects of metals exposures on children's IQ scores. Then, to facilitate future methodological innovation, we show how to use these moments as parameter estimates to simulate multiple synthetic environmental exposure data sets from multivariate normal and multivariate (skewed) Gamma distributions. Also, for the real data analysis, we show how to apply our threshold equation to use BKMR results for feature selection.

# Materials and Methods

## Overview of the R Package

The package aims to provide a robust framework for simulating non-normal environmental exposure data and estimating feature selection thresholds in the context of Bayesian Kernel Machine Regression (BKMR). The core functions of the package include:

1.  Data Simulation: Functions for generating multivariate data from Normal, Gamma, and skewed Gamma distributions.

-   `simulate_group_data()`: Generates data using multivariate normal or Gamma distributions.

2.  Statistical Parametes Estimation: The function `calculate_stats_gaussian()` calculates key statistical moments, including mean, variance, skewness, and correlation matrix, which are essential for understanding the underlying structure of the normally distrubuted data. The function `calculate_stats_gamma()` computes the sample size, gamma distribution parameters (shape and rate), and Spearman correlation matrix for each group, based on the grouping column.

3.  Feature Selection Threshold Calculation: The PIP threshold for feature selection is computed using the `calculate_pip_threshold()` function. This function estimates the threshold based on a Four-Parameter Logistic Regression model (Richard's curve), which adjusts for variations in data and sample size[@richards1959]. The formula used to calculate the PIP threshold is:

```{=tex}
\begin{equation}
y = A + \frac{K - A}{\left( C + e^{-\beta_1 x_1} \right)^{\beta_2 x_2}},\label{eq1}
\end{equation}
```
Where:

• y: the 95th percentile of the PIP values $PIP_{q_{95}}$

• A: Left asymptote, fixed at 0.

• K: Right asymptote, bounded above by 1.

• C: Constant.

• $\beta_1, \beta_2$: Midpoint shift parameters for CV and sample size.

• x1: Log-transformed CV $log_2 (\text{CV})$.

• x2: Log-transformed sample size $log_{10} (\text{Sample Size})$.

A dynamic threshold function was derived from the logistic model to adjust thresholds based on CV and sample size.

```{=tex}
\begin{equation}
    \text{Threshold} = \frac{1}{\left( C + e^{-\beta_1 \log_2 (\text{CV})} \right)^{\beta_2 \log_{10} (\text{SampleSize})}}
\end{equation}
```
4.  Data Transformation Functions

The package includes data transformation functions to prepare data for analysis:

• Scaling by Standard Deviation or MAD: The `trans_ratio()` function scales data by either the standard deviation (SD) or the median absolute deviation (MAD).

• Logarithmic and Root Transformations: The `trans_log()` function applies a logarithmic transformation to the data, and the `trans_root()` function allows for fractional root transformations, helping to manage skewed data.

## Software Implementation

The simBKMRdata software is implemented as an R package. It depends on the following packages: bkmr[@bkmr], fields[@fields], base[@base] and MASS[@MASS]. The R software and these required packages can be obtained from the CRAN website. Furthermore, daily builds of package bkmr are provided on the CRAN website \[.....\]. It has been published under GPL version 3. The source code is available on GitHub at \[https://github.com/khasa006/simBKMRdata\].

### Installation

To install the package from CRAN, use:

```{r}
# install.packages("simBKMRdata")
```

For GitHub installation, use:

```{r}
# devtools::install_github("simBKMRdata")
```

### Example Usage (Data Simuation)

```{r}
library(simBKMRdata)
library(tidyverse)

# Generate Example Dataset
param_list <- list(
   Group1 = list(
     mean_vec = c(1, 2), 
     sampCorr_mat = matrix(c(1, 0.5, 0.5, 1), 2, 2),
     shape_num = c(2, 2), 
     rate_num = c(1, 1), 
     sampSize = 100
   ),
   Group2 = list(
     mean_vec = c(2, 3), 
     sampCorr_mat = matrix(c(1, 0.3, 0.3, 1), 2, 2),
     shape_num = c(2, 2), 
     rate_num = c(1, 1), 
     sampSize = 150
   )
 
)

gamma_samples <- simulate_group_data(param_list, generate_mvGamma_data, "Group")
```

### Example Usage (Parameter Estimation)

```{r}
myData <- data.frame(
   GENDER = c('Male', 'Female', 'Male', 'Female', 'Male', 'Female'),
   VALUE1 = c(1.2, 2.3, 1.5, 2.7, 1.35, 2.5),
   VALUE2 = c(3.4, 4.5, 3.8, 4.2, 3.6, 4.35)
)
calculate_stats_gamma(data_df = myData, group_col= "GENDER", using = "MoM")
```

### Example Usage (PIP Threshold Calculation)

```{r}
# Set seed for reproducibility
set.seed(42)

# Create the dataset
exampleData <- data.frame(
  QI = sample(1:100, 10, replace = TRUE),  # 10 random integers for QI
  Cadmium = runif(10, 0.1, 10.0),          # 10 random floats for Cadmium
  Copper = runif(10, 0.1, 10.0),           # 10 random floats for Copper
  Lead = runif(10, 0.1, 10.0),             # 10 random floats for Lead
  Manganese = runif(10, 0.1, 10.0)         # 10 random floats for Manganese
)

calculate_pip_threshold(y = exampleData$QI)
```

# Result

## Dataset Overview

The data used in this study is sourced from the Taranto Children Study, which includes information on children's IQ scores, metal concentrations (Cadmium, Mercury, Arsenic, Lead, and Manganese), and gender. The dataset was pre-processed to remove missing values, and only the relevant variables---IQ, metal concentrations, and gender---were retained for analysis.

```{r}
# Load the dataset
bkmrAnalysisData_df <- data("metalExposChildren_df")

# Preprocess the data by selecting relevant columns and removing missing values
bkmrAnalysisData_df <- metalExposChildren_df %>%
  select(QI, Cadmium:Manganese, Sex) %>%
  na.omit() %>%
  mutate(
    across(Cadmium:Manganese, ~ trans_log(.))
  )

head(bkmrAnalysisData_df)
```

## Estimation of Moments for Multivariate Skewed Gamma Distribution

To appropriately model the skewed nature of the metal exposure data, we estimate the moments (mean, variance, and skewness) of each metal using a multivariate skewed gamma distribution. This distribution was chosen because metal concentrations often exhibit right skewness and heteroscedasticity, making it a suitable model for these variables.

## Bayesian Kernel Machine Regression (BKMR)

Bayesian Kernel Machine Regression (BKMR) was employed to investigate the effects of metal exposures on children's IQ scores. This method allows for non-linear relationships between predictors (metal exposures) and the outcome (IQ), and is particularly suited for high-dimensional data with complex dependencies.

We used the kmbayes function from the bkmr package to fit the BKMR model. A cover design was used to generate knot points for the model, and posterior inclusion probabilities (PIPs) were extracted to identify significant predictors.

```{r}
#| label: run-bkmr
library(bkmr)

# Extract the response variable (IQ) and the exposure matrix (metals)
iq <- bkmrAnalysisData_df %>% pull(QI)
expos <- bkmrAnalysisData_df %>%
  select(Cadmium:Manganese) %>% 
  data.matrix()

# Generate knot points using a cover design for Bayesian modeling
knots50 <- fields::cover.design(expos, nd = 50)$design

# Fit the BKMR model using MCMC
modelFit <- kmbayes(
  y = iq,         # Response variable
  Z = expos,      # Exposure matrix (metal concentrations)
  X = NULL,       # No additional covariates
  iter = 2000,    # Number of MCMC iterations
  family = "gaussian",  # Gaussian response
  verbose = TRUE,       # Output progress for each iteration
  varsel = TRUE,       # Perform variable selection
  knots = knots50      # Knot points generated earlier
)
```

## Dynamic Threshold Calculation

To assess the relative importance of metal exposures, we calculate a dynamic threshold for variable inclusion. This threshold is based on the coefficient of variation (CV) of the IQ scores and the sample size.

```{r}
# Calculate the dynamic threshold for model inclusion
pipThresh_num <- calculate_pip_threshold(
  absCV = sd(bkmrAnalysisData_df$QI) / mean(bkmrAnalysisData_df$QI),  # Coefficient of variation
  sampSize = length(bkmrAnalysisData_df$QI)  # Sample size
)

pipThresh_num
```

## Identification of Significant Exposures

We then compare the posterior inclusion probabilities (PIPs) with the dynamic threshold to identify significant metal exposures. Exposures with PIPs greater than the dynamic threshold are considered significant predictors of IQ scores.

```{r}
# Extract posterior inclusion probabilities (PIPs) and sort them
pipFit <- ExtractPIPs(modelFit) %>% arrange(desc(PIP))

# Identify exposures with PIPs greater than the threshold
significant_exposures <- pipFit %>% filter(PIP > pipThresh_num)
significant_exposures
```

# Discussion

The R package we developed is a valuable tool for simulating multivariate environmental exposure data and estimating feature selection thresholds for Bayesian Kernel Machine Regression (BKMR). By supporting multivariate normal and skewed Gamma distributions, the package is particularly well-suited for handling non-normal environmental exposure data, which is common in health studies.

While BKMR is an excellent tool for feature selection, its reliance on normality can limit its application to real-world datasets. Our package fills this gap by enabling researchers to model and analyze non-normally distributed data, ensuring that feature selection remains robust even in complex scenarios.

# Conclusion

This R package provides essential tools for simulating multivariate environmental exposure data, estimating statistical moments, and calculating PIP thresholds for feature selection in Bayesian Kernel Machine Regression (BKMR). The ability to simulate data from multivariate normal and skewed Gamma distributions makes the package particularly valuable for environmental health studies where data often deviate from normality.
